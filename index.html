<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مسابقة المليونير من PDF - Gemini</title>

    <!-- مكتبة PDF.js لقراءة PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc =
            'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <style>
        body {
            background: radial-gradient(circle, #020024 0%, #090979 35%, #000000 100%);
            color: #fff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            text-align: center;
        }
        .setup-box, .question-box, .explanation-box {
            background: rgba(0, 0, 40, 0.7);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            border: 2px solid #1cb5e0;
        }
        .main-btn {
            background: linear-gradient(to bottom, #d4af37, #aa8c2c);
            color: #000;
            padding: 12px 35px;
            border-radius: 50px;
            font-size: 20px;
            border: 2px solid white;
            cursor: pointer;
            margin-top: 15px;
        }
        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .option-btn {
            padding: 15px;
            background: #000;
            border-radius: 25px;
            border: 2px solid #444;
            color: white;
            cursor: pointer;
        }
        .correct { background: #38ef7d !important; color: #000; }
        .wrong { background: #ef473a !important; color: #000; }
    </style>
</head>
<body>

<h1 style="color: #d4af37;">مسابقة المليونير من PDF – Gemini API</h1>

<div class="setup-box" id="setupSection">

    <h3>1. اختر ملف PDF:</h3>
    <input type="file" id="pdfFile" accept="application/pdf">

    <button class="main-btn" onclick="start()">ابدأ</button>

    <p id="status" style="color:#ddd; margin-top:10px;"></p>
</div>

<div id="gameArea" style="display:none;">
    <div class="question-box" id="questionText"></div>

    <div class="options-grid" id="optionsContainer"></div>

    <div class="explanation-box" id="explanationBox" style="display:none;">
        <strong style="color:#d4af37;">الشرح:</strong>
        <p id="explanationText"></p>
    </div>

    <button class="main-btn" id="nextBtn" onclick="nextQuestion()" style="display:none;">السؤال التالي</button>
</div>

<script>

    const apiKey = "AIzaSyDPU85pmsRs4sx2adhUSSscy1qqaEWGr7k";  // ← مفتاح Gemini

    let questions = [];
    let currentIndex = 0;

    async function extractPDF(file) {
        const buffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument(buffer).promise;
        let text = "";

        const pages = Math.min(pdf.numPages, 5);
        for (let i = 1; i <= pages; i++) {
            const page = await pdf.getPage(i);
            const content = await page.getTextContent();
            text += content.items.map(i => i.str).join(" ") + "\n";
        }
        return text;
    }

    async function generateQuestions(text) {
        const prompt = `
أنت خبير تعليم. حلّل النص التالي واستخرج منه 5 أسئلة اختيار متعدد.

صيغة الإخراج يجب أن تكون JSON فقط بدون شرح خارجي:

[
  {
    "question": "النص هنا",
    "options": ["A","B","C","D"],
    "answer_index": 1,
    "explanation": "الشرح"
  }
]

النص هو:
${text}
`;

        const response = await fetch(
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=" + apiKey,
            {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }]
                })
            }
        );

        const data = await response.json();
        const raw = data.candidates?.[0]?.content?.parts?.[0]?.text || "";

        const clean = raw.replace(/```json/g, "").replace(/```/g, "");

        return JSON.parse(clean);
    }

    async function start() {
        const file = document.getElementById("pdfFile").files[0];
        if (!file) return alert("اختر ملف PDF أولاً");

        document.getElementById("status").innerText = "جاري قراءة PDF...";

        try {
            const text = await extractPDF(file);

            document.getElementById("status").innerText = "جاري توليد الأسئلة بواسطة Gemini...";

            questions = await generateQuestions(text);

            document.getElementById("status").innerText = "";

            document.getElementById("setupSection").style.display = "none";
            document.getElementById("gameArea").style.display = "block";

            showQuestion(0);

        } catch (e) {
            alert("خطأ: " + e.message);
            document.getElementById("status").innerText = "حدث خطأ أثناء معالجة الملف.";
        }
    }

    function showQuestion(i) {
        currentIndex = i;
        const q = questions[i];

        document.getElementById("questionText").innerText = q.question;
        const container = document.getElementById("optionsContainer");
        container.innerHTML = "";

        document.getElementById("explanationBox").style.display = "none";
        document.getElementById("nextBtn").style.display = "none";

        q.options.forEach((opt, idx) => {
            const btn = document.createElement("button");
            btn.className = "option-btn";
            btn.innerText = opt;

            btn.onclick = () => check(idx, q.answer_index, q.explanation, btn);

            container.appendChild(btn);
        });
    }

    function check(selected, correct, explanation, btn) {
        const allBtns = document.querySelectorAll(".option-btn");
        allBtns.forEach(b => b.disabled = true);

        if (selected === correct) {
            btn.classList.add("correct");
        } else {
            btn.classList.add("wrong");
            allBtns[correct].classList.add("correct");
            document.getElementById("explanationText").innerText = explanation;
            document.getElementById("explanationBox").style.display = "block";
        }

        document.getElementById("nextBtn").style.display = "inline-block";
    }

    function nextQuestion() {
        if (currentIndex < questions.length - 1) {
            showQuestion(currentIndex + 1);
        } else {
            alert("انتهت الأسئلة!");
            location.reload();
        }
    }

</script>

</body>
</html>
